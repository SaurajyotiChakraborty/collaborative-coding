generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  Admin
  User
}

enum QuestionDifficulty {
  Easy
  Medium
  Hard
}

enum CompetitionMode {
  Ai
  Human
}

enum CompetitionStatus {
  Waiting
  InProgress
  Completed
  Archived
}

enum NotificationType {
  ChallengeRequest
  CompetitionStart
  Result
}

enum WorkspaceStatus {
  Active
  Synced
  Archived
  PendingDeletion
}

enum WorkspaceRole {
  Leader
  Maintainer
  Contributor
  Viewer
}

model User {
  id                      String   @id @default(uuid()) // Identity replacement
  username                String   @unique
  email                   String   @unique
  password                String?  // Optional: for credentials auth, null for OAuth-only users
  role                    UserRole @default(User)
  rating                  Int      @default(1200)
  xp                      BigInt   @default(0)
  titles                  String[]
  achievements            String[]
  isCheater               Boolean  @default(false)
  cheaterRedemptionCount  Int      @default(3)
  createdAt               DateTime @default(now())

  // Dynamic Progress Tracking
  learningPathProgress    UserLearningPath[]
  achievementsUnlocked    UserAchievement[]

  createdQuestions        Question[]
  createdCompetitions     Competition[]
  participatedCompetitions Competition[] @relation("CompetitionParticipants")
  submissions             Submission[]
  notifications           Notification[]
  workspaceMemberships    WorkspaceMember[]
  leaderboardEntry        LeaderboardEntry?
  workspaceFiles          WorkspaceFile[]      @relation("LastModifiedBy")
  workspaceLocks          FileLock[]
  workspaceChats          WorkspaceChat[]
  
  // Relations for workspace leadership (optional if just checking ID)
  ledWorkspaces           WorkspaceGroup[]     @relation("Leader")

  @@map("users")
}

model Question {
  id              Int                @id @default(autoincrement())
  title           String
  description     String
  difficulty      QuestionDifficulty
  testCases       Json               // Array of {input, output}
  constraints     String
  tags            String[]
  createdById     String
  createdBy       User               @relation(fields: [createdById], references: [id])
  isAiGenerated   Boolean            @default(false)
  isApproved      Boolean            @default(true)
  createdAt       DateTime           @default(now())
  
  submissions     Submission[]
  competitions    Competition[]      @relation("CompetitionQuestions")
  
  // Practice improvements
  canonicalSolution     String?
  optimalTimeComplexity String?
  optimalSpaceComplexity String?
  optimalScore          Int? @default(100)

  learningPaths         LearningPath[]     @relation("PathQuestions")
  dailyChallenges       DailyChallenge[]

  @@map("questions")
}

model Competition {
  id                  Int               @id @default(autoincrement())
  mode                CompetitionMode
  maxParticipants     Int
  // Participants stored as many-to-many relation ideally, but Spacetime used Vec<Identity>
  // Here we normalize to a relation table or implicit relation
  participants        User[]            @relation("CompetitionParticipants")
  
  questions           Question[]        @relation("CompetitionQuestions")
  
  startTime           DateTime?
  endTime             DateTime?
  status              CompetitionStatus @default(Waiting)
  hasTimeLimit        Boolean           @default(false)
  timeLimitMinutes    Int?
  
  createdById         String
  createdBy           User              @relation(fields: [createdById], references: [id])
  createdAt           DateTime          @default(now())

  submissions         Submission[]

  @@map("competitions")
}

model Submission {
  id                  Int       @id @default(autoincrement())
  userId              String
  user                User      @relation(fields: [userId], references: [id])
  
  competitionId       Int
  competition         Competition @relation(fields: [competitionId], references: [id])
  
  questionId          Int
  question            Question    @relation(fields: [questionId], references: [id])
  
  code                String
  language            String
  timeComplexity      String
  spaceComplexity     String
  complexityScore     Int       @default(0)
  allTestsPassed      Boolean
  executionTimeMs     Int
  submittedAt         DateTime  @default(now())

  @@map("submissions")
}

model LeaderboardEntry {
  userId              String    @id
  user                User      @relation(fields: [userId], references: [id])
  
  rank                Int
  totalPoints         BigInt
  totalWins           Int
  currentStreak       Int
  bestStreak          Int
  competitionsCompleted Int
  updatedAt           DateTime  @updatedAt

  @@map("leaderboard")
}

model Notification {
  id                  Int              @id @default(autoincrement())
  userId              String
  user                User             @relation(fields: [userId], references: [id])
  
  type                NotificationType
  message             String
  competitionId       Int?
  isRead              Boolean          @default(false)
  createdAt           DateTime         @default(now())

  @@map("notifications")
}

model WorkspaceGroup {
  id                  Int               @id @default(autoincrement())
  name                String
  leaderId            String
  leader              User              @relation("Leader", fields: [leaderId], references: [id])
  
  inviteCode          String            @unique
  gitRepoUrl          String
  gitBranch           String
  cloudStoragePath    String
  createdAt           DateTime          @default(now())
  status              WorkspaceStatus   @default(Active)

  members             WorkspaceMember[]
  files               WorkspaceFile[]
  chats               WorkspaceChat[]
  locks               FileLock[]

  @@map("workspace_groups")
}

model WorkspaceMember {
  id                  Int             @id @default(autoincrement())
  workspaceId         Int
  workspace           WorkspaceGroup  @relation(fields: [workspaceId], references: [id])
  
  userId              String
  user                User            @relation(fields: [userId], references: [id])
  
  role                WorkspaceRole
  joinedAt            DateTime        @default(now())
  gitUsername         String
  isOnline            Boolean         @default(false)

  @@map("workspace_members")
}

model FileLock {
  id                  Int             @id @default(autoincrement())
  workspaceId         Int
  workspace           WorkspaceGroup  @relation(fields: [workspaceId], references: [id])
  
  filePath            String
  lockedById          String
  lockedBy            User            @relation(fields: [lockedById], references: [id])
  
  lockedAt            DateTime        @default(now())
  lastActivity        DateTime

  @@map("file_locks")
}

model WorkspaceFile {
  id                  Int             @id @default(autoincrement())
  workspaceId         Int
  workspace           WorkspaceGroup  @relation(fields: [workspaceId], references: [id])
  
  filePath            String
  content             String
  
  lastModifiedById    String
  lastModifiedBy      User            @relation("LastModifiedBy", fields: [lastModifiedById], references: [id])
  
  lastModifiedAt      DateTime        @updatedAt
  version             Int             @default(1)

  @@unique([workspaceId, filePath])
  @@map("workspace_files")
}

model WorkspaceChat {
  id                  Int             @id @default(autoincrement())
  workspaceId         Int
  workspace           WorkspaceGroup  @relation(fields: [workspaceId], references: [id])
  
  userId              String
  user                User            @relation(fields: [userId], references: [id])
  
  username            String
  message             String
  timestamp           DateTime        @default(now())

  @@map("workspace_chats")
}

model LearningPath {
  id                  String           @id @default(uuid())
  name                String
  description         String
  category            String
  difficulty          String
  order               Int              @default(0)
  
  questions           Question[]       @relation("PathQuestions")
  userProgress        UserLearningPath[]

  @@map("learning_paths")
}

model UserLearningPath {
  id                  String           @id @default(uuid())
  userId              String
  user                User             @relation(fields: [userId], references: [id])
  pathId              String
  path                LearningPath     @relation(fields: [pathId], references: [id])
  
  progress            Float            @default(0)
  completed           Boolean          @default(false)
  updatedAt           DateTime         @updatedAt

  @@unique([userId, pathId])
  @@map("user_learning_paths")
}

model Achievement {
  id                  String           @id @default(uuid())
  name                String
  description         String
  icon                String
  requirementType     String           // e.g., 'CompetitionsWon', 'QuestionsSolved'
  requirementValue    Int
  xpReward            Int              @default(50)
  
  unlockedBy          UserAchievement[]

  @@map("achievements_defs")
}

model UserAchievement {
  id                  String           @id @default(uuid())
  userId              String
  user                User             @relation(fields: [userId], references: [id])
  achievementId       String
  achievement         Achievement      @relation(fields: [achievementId], references: [id])
  
  unlockedAt          DateTime         @default(now())

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model DailyChallenge {
  id                  String           @id @default(uuid())
  date                DateTime         @unique
  questionId          Int
  question            Question         @relation(fields: [questionId], references: [id])
  bonusMultiplier     Float            @default(1.5)
  
  @@map("daily_challenges")
}
